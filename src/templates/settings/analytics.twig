{% extends "shortlink-manager/_layouts/settings" %}
{% import "_includes/forms" as forms %}

{% set title = "Analytics Settings"|t('shortlink-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'analytics' %}

{% set plugin = craft.app.plugins.getPlugin('shortlink-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('shortlink-manager'),
        url: url('shortlink-manager'),
    },
    {
        label: 'Settings'|t('shortlink-manager'),
        url: url('shortlink-manager/settings'),
    },
] %}

{% block actionButton %}
    <div class="btngroup">
        <input type="submit" class="btn submit" value="{{ 'Save'|t('app') }}">
    </div>
{% endblock %}

{% block content %}
    {% set pluginName = plugin.settings.pluginName %}

    {% include 'shortlink-manager/_components/ip-salt-error' %}

    <form method="post" accept-charset="UTF-8">
        <input type="hidden" name="action" value="shortlink-manager/settings/save">
        {{ csrfInput() }}
        {{ redirectInput('shortlink-manager/settings/analytics') }}
        {{ hiddenInput('section', 'analytics') }}

    <h2 style="margin-top: 0px;">{{ "Analytics"|t('shortlink-manager') }}</h2>

    {{ forms.lightswitchField({
        label: "Enable Analytics"|t('shortlink-manager'),
        instructions: "Track clicks and visitor data for {pluginName}"|t('shortlink-manager', {pluginName: pluginName|lower}),
        id: 'enableAnalytics',
        name: 'settings[enableAnalytics]',
        on: settings.enableAnalytics ?? true,
        toggle: 'analytics-settings',
        disabled: settings.isOverriddenByConfig('enableAnalytics'),
        warning: settings.isOverriddenByConfig('enableAnalytics') ?
            "This is being overridden by the <code>enableAnalytics</code> setting in <code>config/shortlink-manager.php</code>."|t('shortlink-manager')|raw : null,
    }) }}

    <div id="analytics-settings" class="{{ not (settings.enableAnalytics ?? true) ? 'hidden' }}">
        <div class="field">
            <p class="light">{{ "When enabled, {pluginName} will track visitor interactions, device types, geographic data, and other analytics information."|t('shortlink-manager', {pluginName: pluginName}) }}</p>
        </div>

        <hr>

        <h2>{{ "Geographic Detection"|t('shortlink-manager') }}</h2>

        {{ forms.lightswitchField({
            label: "Enable Geographic Detection"|t('shortlink-manager'),
            instructions: "Detect user location for analytics"|t('shortlink-manager'),
            id: 'enableGeoDetection',
            name: 'settings[enableGeoDetection]',
            on: settings.enableGeoDetection ?? false,
            disabled: settings.isOverriddenByConfig('enableGeoDetection'),
            warning: settings.isOverriddenByConfig('enableGeoDetection') ?
                "This is being overridden by the <code>enableGeoDetection</code> setting in <code>config/shortlink-manager.php</code>."|t('shortlink-manager')|raw : null,
        }) }}

        <hr>

        <h2>{{ "IP Address Privacy"|t('shortlink-manager') }}</h2>

        {{ forms.lightswitchField({
            label: "Anonymize IP Addresses"|t('shortlink-manager'),
            instructions: "Mask IP addresses before storage for maximum privacy. <strong>IPv4</strong>: masks last octet (192.168.1.123 → 192.168.1.0). <strong>IPv6</strong>: masks last 80 bits. <strong>Trade-off</strong>: Reduces unique visitor accuracy (users on same subnet counted as one visitor). Geo-location still works normally."|t('shortlink-manager')|raw,
            id: 'anonymizeIpAddress',
            name: 'settings[anonymizeIpAddress]',
            on: settings.anonymizeIpAddress ?? false,
            disabled: settings.isOverriddenByConfig('anonymizeIpAddress'),
            warning: settings.isOverriddenByConfig('anonymizeIpAddress') ?
                "This is being overridden by the <code>anonymizeIpAddress</code> setting in <code>config/shortlink-manager.php</code>."|t('shortlink-manager')|raw : null,
        }) }}

        <div class="field">
            <p class="light">
                <strong>Privacy Levels:</strong><br>
                • <strong>Disabled</strong> (default): Full IP hashed with salt (accurate unique visitors)<br>
                • <strong>Enabled</strong>: Subnet masked + hashed with salt (maximum privacy, less accurate)
            </p>
        </div>

        <hr>

        <h2>{{ "Data Retention"|t('shortlink-manager') }}</h2>

        {{ forms.textField({
            label: "Analytics Retention"|t('shortlink-manager'),
            instructions: "How many days to keep analytics data (0 for unlimited, max 3650)"|t('shortlink-manager'),
            id: 'analyticsRetention',
            name: 'settings[analyticsRetention]',
            value: settings.analyticsRetention ?? 90,
            type: 'number',
            min: 0,
            max: 3650,
            disabled: settings.isOverriddenByConfig('analyticsRetention'),
            warning: settings.isOverriddenByConfig('analyticsRetention') ?
                "This is being overridden by the <code>analyticsRetention</code> setting in <code>config/shortlink-manager.php</code>."|t('shortlink-manager')|raw : null,
            errors: (settings is defined and settings) ? settings.getErrors('analyticsRetention') : []
        }) }}

        {% if (settings.analyticsRetention ?? 90) > 0 %}
            <div class="field" style="margin-top: 20px;">
                <div class="heading">
                    <label>{{ "Analytics Cleanup"|t('shortlink-manager') }}</label>
                    <div class="instructions">
                        <p>{{ "Analytics data older than {days} days will be automatically cleaned up daily."|t('shortlink-manager', {days: settings.analyticsRetention ?? 90}) }}</p>
                    </div>
                </div>
                <button type="button" class="btn" id="cleanup-analytics-now">
                    {{ "Clean Up Now"|t('shortlink-manager') }}
                </button>
            </div>
        {% elseif (settings.analyticsRetention ?? 90) == 0 %}
            <div class="field" style="margin-top: 20px;">
                <div class="heading">
                    <label>{{ "Unlimited Retention Warning"|t('shortlink-manager') }}</label>
                    <div class="instructions" style="color: #da5a47;">
                        <p><strong>{{ "Warning"|t('shortlink-manager') }}:</strong> {{ "Analytics data will be retained indefinitely. This could result in large database size, slower performance, and increased storage costs over time. Consider setting a retention period (recommended: 90-365 days) for production sites."|t('shortlink-manager') }}</p>
                    </div>
                </div>
            </div>
        {% endif %}

        <hr>

        <h2>{{ "Performance & Caching"|t('shortlink-manager') }}</h2>

        <div class="field">
            <p class="light">
                {{ "Configure device detection caching for better performance."|t('shortlink-manager') }}
                <a href="{{ url('shortlink-manager/settings/cache') }}">{{ "Go to Cache Settings"|t('shortlink-manager') }}</a>
            </p>
        </div>

    </div>{# end #analytics-settings #}

    <div class="buttons">
        <button type="submit" class="btn submit">{{ "Save Settings"|t('shortlink-manager') }}</button>
    </div>
    </form>

    {% include 'shortlink-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
    $('#cleanup-analytics-now').on('click', function() {
        if (!confirm('{{ "Are you sure you want to clean up old analytics data now?"|t('shortlink-manager')|e('js') }}')) {
            return;
        }

        const $btn = $(this);
        $btn.addClass('loading').prop('disabled', true);

        $.ajax({
            url: '{{ actionUrl('shortlink-manager/settings/cleanup-analytics')|raw }}',
            type: 'POST',
            dataType: 'json',
            data: {
                {{ craft.app.config.general.csrfTokenName }}: '{{ craft.app.request.csrfToken }}'
            },
            success: function(response) {
                if (response.success) {
                    Craft.cp.displayNotice(response.message || '{{ "Analytics cleanup job queued"|t('shortlink-manager')|e('js') }}');
                } else {
                    Craft.cp.displayError(response.error || '{{ "Failed to queue cleanup job"|t('shortlink-manager')|e('js') }}');
                }
            },
            error: function() {
                Craft.cp.displayError('{{ "Failed to queue cleanup job"|t('shortlink-manager')|e('js') }}');
            },
            complete: function() {
                $btn.removeClass('loading').prop('disabled', false);
            }
        });
    });
{% endjs %}
