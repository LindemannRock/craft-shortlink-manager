{% set dateRange = dateRange ?? craft.app.request.getQueryParam('range') ?? 'last7days' %}

{# Get analytics data using the service directly #}
{% set analyticsService = craft.app.plugins.getPlugin('shortlink-manager').analytics %}
{% set analytics = analyticsService.getLinkAnalytics(link.id, dateRange) %}

{% if analytics.totalClicks == 0 %}
    <div class="zilch">
        <p>{{ "No analytics data yet"|t('shortlink-manager') }}</p>
        <p class="light">{{ "Analytics will appear here once your shortlink starts receiving clicks."|t('shortlink-manager') }}</p>
    </div>
{% else %}

{# Summary Stats #}
<div class="analytics-stats">
    <div class="stat-box">
        <div class="stat-value">{{ analytics.totalClicks }}</div>
        <div class="stat-label">{{ "Total Interactions"|t('shortlink-manager') }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ analytics.uniqueClicks }}</div>
        <div class="stat-label">{{ "Unique Visitors"|t('shortlink-manager') }}</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ analytics.averageClicksPerDay }}</div>
        <div class="stat-label">{{ "Avg. Clicks/Day"|t('shortlink-manager') }}</div>
    </div>
</div>

{# Charts Section #}
<div class="analytics-charts two-columns" style="margin-top: 20px;">
    {# Device Breakdown #}
    <div class="chart-container">
        <h3>{{ "Device Breakdown"|t('shortlink-manager') }}</h3>
        {% if analytics.deviceBreakdown|length %}
            <canvas id="link-device-chart"></canvas>
        {% else %}
            <p class="light" style="text-align: center; padding: 40px 0;">{{ "Device information not available"|t('shortlink-manager') }}</p>
        {% endif %}
    </div>

    {# Browser Breakdown #}
    <div class="chart-container">
        <h3>{{ "Browser Usage"|t('shortlink-manager') }}</h3>
        {% if analytics.browserBreakdown|length %}
            <canvas id="link-browser-chart"></canvas>
        {% else %}
            <p class="light" style="text-align: center; padding: 40px 0;">{{ "Browser information not available"|t('shortlink-manager') }}</p>
        {% endif %}
    </div>
</div>

<div class="analytics-charts two-columns" style="margin-top: 20px;">
    {# OS Breakdown #}
    <div class="chart-container">
        <h3>{{ "Operating System"|t('shortlink-manager') }}</h3>
        {% if analytics.osBreakdown|length %}
            <canvas id="link-os-chart"></canvas>
        {% else %}
            <p class="light" style="text-align: center; padding: 40px 0;">{{ "OS information not available"|t('shortlink-manager') }}</p>
        {% endif %}
    </div>
</div>

{# Latest Interactions #}
{% if analytics.recentClicks|length %}
    <h3 style="margin-top: 30px;">{{ "Latest Interactions"|t('shortlink-manager') }}</h3>
    <div class="recent-clicks" style="overflow-x: auto; max-width: 100%;">
        <table class="data fullwidth">
            <thead>
                <tr>
                    <th>{{ "Date"|t('shortlink-manager') }}</th>
                    <th>{{ "Site"|t('app') }}</th>
                    <th>{{ "Source"|t('shortlink-manager') }}</th>
                    <th>{{ "Destination"|t('shortlink-manager') }}</th>
                    <th>{{ "Device"|t('shortlink-manager') }}</th>
                    <th>{{ "Browser"|t('shortlink-manager') }}</th>
                    <th>{{ "OS"|t('shortlink-manager') }}</th>
                    {% if craft.app.plugins.getPlugin('shortlink-manager').settings.enableGeoDetection %}
                        <th>{{ "Location"|t('shortlink-manager') }}</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for click in analytics.recentClicks %}
                    <tr>
                        <td>{{ click.dateCreated|datetime('short') }}</td>
                        <td>
                            {% if click.siteId %}
                                {% set site = craft.app.sites.getSiteById(click.siteId) %}
                                {{ site ? site.name : '—' }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            {% set source = 'direct' %}
                            {% if click.metadata %}
                                {% set metadata = click.metadata|json_decode %}
                                {% set source = metadata.source ?? 'direct' %}
                            {% endif %}
                            {% if source == 'qr' %}
                                {{ "QR"|t('shortlink-manager') }}
                            {% else %}
                                {{ "Direct"|t('shortlink-manager') }}
                            {% endif %}
                        </td>
                        <td>
                            {% if click.destinationUrl %}
                                <span title="{{ click.destinationUrl }}">
                                    {{ click.destinationUrl|length > 40 ? click.destinationUrl|slice(0, 40) ~ '...' : click.destinationUrl }}
                                </span>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>{{ click.deviceType ? click.deviceType|capitalize : '—' }}</td>
                        <td>{{ click.browser ?? '—' }}</td>
                        <td>{{ click.osName ?? '—' }}</td>
                        {% if craft.app.plugins.getPlugin('shortlink-manager').settings.enableGeoDetection %}
                            <td>
                                {% if click.city and click.country %}
                                    {{ click.city }}, {{ click.country }}
                                {% elseif click.country %}
                                    {{ click.country }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}

{% js %}
// Load Chart.js if not already loaded
if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
    script.onload = function() {
        initializeLinkCharts();
    };
    document.head.appendChild(script);
} else {
    // For AJAX loads, initialize immediately
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLinkCharts);
    } else {
        // DOM is already loaded (AJAX request), initialize now
        initializeLinkCharts();
    }
}

// Store chart instances globally to destroy them before creating new ones
window.shortlinkCharts = window.shortlinkCharts || {};

function initializeLinkCharts() {
    // Destroy existing charts if they exist
    if (window.shortlinkCharts.deviceChart) {
        window.shortlinkCharts.deviceChart.destroy();
    }
    if (window.shortlinkCharts.browserChart) {
        window.shortlinkCharts.browserChart.destroy();
    }
    if (window.shortlinkCharts.osChart) {
        window.shortlinkCharts.osChart.destroy();
    }

    const chartColors = ['#0d78f2', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];

    // Device chart
    const deviceData = {{ analytics.deviceBreakdown|json_encode|raw }};
    if (deviceData && Object.keys(deviceData).length > 0) {
        const deviceCtx = document.getElementById('link-device-chart');
        if (deviceCtx) {
            window.shortlinkCharts.deviceChart = new Chart(deviceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(deviceData).map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                    datasets: [{
                        data: Object.values(deviceData),
                        backgroundColor: chartColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    }

    // Browser chart
    const browserData = {{ analytics.browserBreakdown|json_encode|raw }};
    if (browserData && Object.keys(browserData).length > 0) {
        const browserCtx = document.getElementById('link-browser-chart');
        if (browserCtx) {
            // Set explicit height for bar chart to match donut charts
            browserCtx.parentElement.style.minHeight = '300px';

            window.shortlinkCharts.browserChart = new Chart(browserCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(browserData),
                    datasets: [{
                        label: '{{ "Clicks"|t('shortlink-manager') }}',
                        data: Object.values(browserData),
                        backgroundColor: chartColors[0]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }

    // OS chart
    const osData = {{ analytics.osBreakdown|json_encode|raw }};
    if (osData && Object.keys(osData).length > 0) {
        const osCtx = document.getElementById('link-os-chart');
        if (osCtx) {
            window.shortlinkCharts.osChart = new Chart(osCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(osData),
                    datasets: [{
                        data: Object.values(osData),
                        backgroundColor: chartColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    }
}
{% endjs %}

{% endif %}
