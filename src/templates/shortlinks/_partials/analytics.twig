{% set dateRange = craft.app.request.getQueryParam('range') ?? 'last7days' %}

{# Get analytics data using the service directly #}
{% set plugin = craft.app.plugins.getPlugin('shortlink-manager') %}
{% set analytics = plugin.analytics.getLinkAnalytics(shortLink.id, dateRange) %}

<div class="analytics-container">
    {# Date Range Selector #}
    <div class="analytics-header">
        <div class="flex">
            <div class="btngroup">
                <button type="button" class="btn menubtn">
                    <span>{{ dateRange == 'today' ? 'Today' : (dateRange == 'yesterday' ? 'Yesterday' : (dateRange == 'last7days' ? 'Last 7 days' : (dateRange == 'last30days' ? 'Last 30 days' : (dateRange == 'last90days' ? 'Last 90 days' : 'All time')))) }}</span>
                </button>
                <div class="menu">
                    <ul>
                        <li><a href="#" data-range="today" class="link-date-range-option {{ dateRange == 'today' ? 'sel' : '' }}">{{ "Today"|t('shortlink-manager') }}</a></li>
                        <li><a href="#" data-range="yesterday" class="link-date-range-option {{ dateRange == 'yesterday' ? 'sel' : '' }}">{{ "Yesterday"|t('shortlink-manager') }}</a></li>
                        <li><a href="#" data-range="last7days" class="link-date-range-option {{ dateRange == 'last7days' ? 'sel' : '' }}">{{ "Last 7 days"|t('shortlink-manager') }}</a></li>
                        <li><a href="#" data-range="last30days" class="link-date-range-option {{ dateRange == 'last30days' ? 'sel' : '' }}">{{ "Last 30 days"|t('shortlink-manager') }}</a></li>
                        <li><a href="#" data-range="last90days" class="link-date-range-option {{ dateRange == 'last90days' ? 'sel' : '' }}">{{ "Last 90 days"|t('shortlink-manager') }}</a></li>
                        <li><a href="#" data-range="all" class="link-date-range-option {{ dateRange == 'all' ? 'sel' : '' }}">{{ "All time"|t('shortlink-manager') }}</a></li>
                    </ul>
                </div>
            </div>
            <div class="flex-grow"></div>
            <div class="btngroup">
                <button type="button" class="btn menubtn" data-icon="download">{{ "Export"|t('shortlink-manager') }}</button>
                <div class="menu" data-align="right">
                    <ul>
                        <li><a href="#" class="export-link-analytics" data-format="csv">{{ "Export as CSV"|t('shortlink-manager') }}</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="link-analytics-content" data-link-id="{{ shortLink.id }}">
        {% include "shortlink-manager/shortlinks/_partials/analytics-content" %}
    </div>
</div>

{% js %}
$(document).ready(function() {
    // Handle export clicks
    $(document).on('click', '.export-link-analytics', function(e) {
        e.preventDefault();

        const format = $(this).data('format');
        const linkId = $('#link-analytics-content').data('link-id');
        const currentRange = new URLSearchParams(window.location.search).get('range') || 'last7days';

        // Build export URL (reuse the main export action with linkId filter)
        const exportUrl = Craft.getActionUrl('shortlink-manager/analytics/export', {
            linkId: linkId,
            dateRange: currentRange,
            format: format
        });

        // Trigger download
        window.location.href = exportUrl;

        // Close the menu
        $(this).closest('.menu').removeClass('active');
        $(this).closest('.btngroup').find('.menubtn').removeClass('active');
    });

    // Handle date range selection via AJAX
    $(document).on('click', '.link-date-range-option', function(e) {
        e.preventDefault();

        const $btn = $(this);
        const range = $btn.data('range');
        const linkId = $('#link-analytics-content').data('link-id');

        // Update button text
        const rangeLabels = {
            'today': '{{ "Today"|t('shortlink-manager')|e('js') }}',
            'yesterday': '{{ "Yesterday"|t('shortlink-manager')|e('js') }}',
            'last7days': '{{ "Last 7 days"|t('shortlink-manager')|e('js') }}',
            'last30days': '{{ "Last 30 days"|t('shortlink-manager')|e('js') }}',
            'last90days': '{{ "Last 90 days"|t('shortlink-manager')|e('js') }}',
            'all': '{{ "All time"|t('shortlink-manager')|e('js') }}'
        };

        $btn.closest('.btngroup').find('.menubtn span').text(rangeLabels[range] || range);

        // Update selected state
        $btn.closest('ul').find('.sel').removeClass('sel');
        $btn.addClass('sel');

        // Close the menu
        $btn.closest('.menu').removeClass('active');
        $btn.closest('.btngroup').find('.menubtn').removeClass('active');

        // Show loading state
        $('#link-analytics-content').css('opacity', '0.5');

        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('range', range);
        window.history.pushState({}, '', url);

        // Reload analytics via page refresh for now
        window.location.reload();
    });
});
{% endjs %}

{% css %}
.analytics-container {
    padding: 24px 0;
}

.analytics-header {
    margin-bottom: 24px;
}

.analytics-header .flex {
    display: flex;
    align-items: center;
    gap: 12px;
}

.analytics-header .flex-grow {
    flex-grow: 1;
}

.analytics-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-box {
    background: #f3f7fc;
    padding: 24px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid var(--border-hairline);
}

.stat-value {
    font-size: 32px;
    font-weight: 600;
    color: #0d78f2;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: #596673;
}

.analytics-charts.two-columns {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    margin-bottom: 30px;
}

@media (max-width: 1024px) {
    .analytics-charts.two-columns {
        grid-template-columns: 1fr;
    }
}

.chart-container {
    background: #fff;
    border: 1px solid #e3e5e8;
    border-radius: 4px;
    padding: 24px;
    min-width: 0; /* Allow flex/grid item to shrink below content size */
    overflow: hidden; /* Prevent content from pushing out */
}

.chart-container h3 {
    margin: 0 0 20px;
    font-size: 16px;
}

.chart-container canvas {
    max-height: 300px;
    max-width: 100%;
}

/* Ensure chart wrapper respects container size */
.chart-container > canvas {
    display: block;
    box-sizing: border-box;
}
{% endcss %}
